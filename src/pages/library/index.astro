---
import Layout from '../../layouts/Layout.astro'

// 本地 JSON
import movieData from '../../data/douban/movie.json'
import bookData from '../../data/douban/book.json'
import gameData from '../../data/douban/game.json'
import recentData from '../../data/douban/recent.json'

// —— 工具：把不同 JSON 结构“规范化”为统一字段 ——
function normalizeRows(cat: string, jsonData: any) {
  const rows = Array.isArray(jsonData)
    ? jsonData
    : (jsonData?.data ?? jsonData?.items ?? jsonData?.results ?? [])

  if (!Array.isArray(rows)) return []

  return rows.map((raw: any) => {
    const item = raw?.item ?? raw

    // 时间字段兜底
    const created =
      raw?.created_time ??
      raw?.created_at ??
      item?.created_time ??
      item?.created_at ??
      raw?.time ??
      raw?.date ??
      raw?.updated_at ??
      raw?.date ??
      ''

    // 标题兜底
    const title =
      item?.title ??
      item?.name ??
      item?.original_title ??
      item?.subject ??
      raw?.title ??
      ''

    // 封面兜底
    const cover =
      item?.cover_image_url ??
      item?.cover ??
      item?.image ??
      item?.poster ??
      item?.pic ??
      item?.thumbnail ??
      raw?.cover ??
      ''

    // 唯一 ID 兜底（从 link 提取）
    let uuid = item?.uuid ?? item?.id ?? item?.slug ?? item?.sid ?? ''
    if (!uuid && raw?.link) {
      const parts = raw.link.split('/')
      uuid = parts[parts.length - 2] || parts[parts.length - 1]
    }

    return {
      ...raw,
      _item: item,
      _created: created,
      _title: title,
      _cover: cover,
      _uuid: uuid,
      category: cat,
    }
  })
}

// 处理本地数据
const grouped = {
  movie: normalizeRows('movie', movieData),
  tv: normalizeRows('tv', movieData), // 目前共用
  book: normalizeRows('book', bookData),
  game: normalizeRows('game', gameData),
}

// 使用 recentData 作为最近一个月的数据
const mergedRecentItems = recentData
  .map((raw: any) => ({
    ...raw,
    _title: raw.title,
    _cover: raw.cover,
    _created: raw.date,
    _uuid: raw.link ? raw.link.split('/')[4] : '',
    category: raw.category || 'unknown',
  }))
  .sort((a, b) => (new Date(b._created) as any) - (new Date(a._created) as any))

const tabs = [
  {
    id: 'recent',
    label: 'Last Month',
    items: mergedRecentItems,
    checked: true,
  },
  { id: 'movie', label: '影', items: grouped.movie },
  { id: 'tv', label: '剧', items: grouped.tv, hideTab: true },
  { id: 'book', label: '书', items: grouped.book },
  { id: 'game', label: '游', items: grouped.game },
]

// 跳转链接（优先使用原始 link；否则构建到豆瓣的对应页面）
const getLink = (entry: any) => {
  if (entry.link) return entry.link
  const id = entry._uuid || ''
  if (!id) return '#'

  switch (entry.category) {
    case 'movie':
    case 'tv':
      return `https://movie.douban.com/subject/${id}`
    case 'book':
      return `https://book.douban.com/subject/${id}`
    case 'game':
      // 通用豆瓣条目页面，游戏在部分场景下没有独立二级域名
      return `https://www.douban.com/subject/${id}`
    default:
      return `https://douban.com/subject/${id}`
  }
}
---

<Layout title='书影游档案' description='YG 的精神食粮'>
  <div class='container mx-auto'>
    <div class='tabset mb-6'>
      {
        tabs.map(tab => (
          <input
            id={`tab-${tab.id}`}
            type='radio'
            name='neoTabs'
            class='tab-input'
            checked={tab.checked}
          />
        ))
      }

      <div
        class='tabs flex flex-wrap gap-2 md:gap-3 border-b border-black/10 dark:border-white/10 pb-2'>
        {
          tabs
            .filter(t => !t.hideTab)
            .map(tab => (
              <label
                for={`tab-${tab.id}`}
                class='group flex justify-between gap-3 text-sm px-2 py-1 rounded bg-bgdefault dark:bg-fontdefault text-fontdefault dark:text-bgdefault cursor-pointer'>
                {tab.label}
              </label>
            ))
        }
      </div>

      <div class='panels mt-6'>
        {
          tabs.map(tab => (
            <section id={`panel-${tab.id}`} class='tab-panel'>
              {tab.items?.length ? (
                <div class='grid grid-cols-2 md:grid-cols-5 gap-3'>
                  {tab.items.map(entry => (
                    <div class='block group'>
                      <a
                        href={getLink(entry)}
                        target='_blank'
                        rel='noopener noreferrer'
                        class='block'>
                        <div class='relative rounded overflow-hidden bg-zinc-100 dark:bg-zinc-800 aspect-[2/3]'>
                          <img
                            src={entry._cover}
                            alt={entry._title}
                            loading='lazy'
                            decoding='async'
                            referrerpolicy='no-referrer'
                            class='w-full h-full object-cover block transition-opacity duration-300'
                            onerror="this.style.opacity='0'; this.nextElementSibling.style.display='flex';"
                          />
                          <div
                            class='hidden absolute inset-0 flex-col items-center justify-center bg-zinc-100 dark:bg-zinc-800 cursor-pointer'
                            onclick="event.preventDefault(); const img = this.previousElementSibling; img.src = img.src.split('?')[0] + '?t=' + Date.now(); img.style.opacity='1'; this.style.display='none';">
                            <span class='text-xs text-gray-400'>加载失败</span>
                            <span class='text-xs text-blue-500'>点击重试</span>
                          </div>
                        </div>
                        <p
                          class='mt-2 text-sm text-center text-gray-500 dark:text-gray-500 truncate w-full px-1'
                          title={entry._title}>
                          {entry._title}
                        </p>
                      </a>
                    </div>
                  ))}
                </div>
              ) : (
                <p class='text-gray-500'>
                  {tab.id === 'recent' ? '最近 1 个月暂无数据' : '暂无数据'}
                </p>
              )}
              {tab.id === 'recent' && (
                <p class='mt-10 text-sm text-gray-400 text-center'>
                  ⚠️偶尔会对之前看过的内容进行查漏补缺
                </p>
              )}
            </section>
          ))
        }
      </div>
    </div>
  </div>

  <style>
    /* 隐藏 radio */
    .tab-input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    /* 面板显示/隐藏 */
    .tab-panel {
      display: none;
    }
    #tab-recent:checked ~ .panels #panel-recent {
      display: block;
    }
    #tab-movie:checked ~ .panels #panel-movie {
      display: block;
    }
    #tab-tv:checked ~ .panels #panel-tv {
      display: block;
    }
    #tab-book:checked ~ .panels #panel-book {
      display: block;
    }
    #tab-game:checked ~ .panels #panel-game {
      display: block;
    }
  </style>
</Layout>
