---
import Layout from '../../layouts/Layout.astro'

// 本地 JSON
import movieData from './data/douban/movie.json'
import bookData from './data/douban/book.json'
import gameData from './data/douban/game.json'
import recentData from './data/douban/recent.json'

// 本地数据映射
const localData = {
  movie: movieData,
  tv: movieData, // TV 和电影共用
  game: gameData,
  book: bookData,
}

// 中文短名（用于标题/标签）
const categoryMap = {
  movie: '影',
  // tv: '剧',
  game: '游',
  book: '书'
}

// 归集
const grouped: Record<string, any[]> = {} // 各分类全部（已排序，不限数量）
let mergedRecentItems: any[] = [] // 近 1 个月

// 时间窗口：近 1 个月
const now = new Date()
const oneMonthAgo = new Date(now)
oneMonthAgo.setMonth(now.getMonth() - 1)

// —— 工具：把不同 JSON 结构“规范化”为统一字段 ——
// 期望输出形态：{ _title, _cover, _uuid, _created, _item, category }
function normalizeRows(cat: string, jsonData: any) {
  const rows = Array.isArray(jsonData)
    ? jsonData
    : (jsonData?.data ?? jsonData?.items ?? jsonData?.results ?? [])

  if (!Array.isArray(rows)) return []

  return rows.map((raw: any) => {
    const item = raw?.item ?? raw

    // 时间字段兜底
    const created =
      raw?.created_time ??
      raw?.created_at ??
      item?.created_time ??
      item?.created_at ??
      raw?.time ??
      raw?.date ??
      raw?.updated_at ??
      raw?.date ??
      ''

    // 标题兜底
    const title =
      item?.title ??
      item?.name ??
      item?.original_title ??
      item?.subject ??
      raw?.title ??
      ''

    // 封面兜底
    const cover =
      item?.cover_image_url ??
      item?.cover ??
      item?.image ??
      item?.poster ??
      item?.pic ??
      item?.thumbnail ??
      raw?.cover ??
      ''

    // 唯一 ID 兜底（从 link 提取）
    let uuid = item?.uuid ?? item?.id ?? item?.slug ?? item?.sid ?? ''
    if (!uuid && raw?.link) {
      const parts = raw.link.split('/')
      uuid = parts[parts.length - 2] || parts[parts.length - 1]
    }

    return {
      ...raw,
      _item: item,
      _created: created,
      _title: title,
      _cover: cover,
      _uuid: uuid,
      category: cat,
    }
  })
}

// 处理本地数据
Object.entries(localData).forEach(([cat, jsonData]) => {
  const normalized = normalizeRows(cat, jsonData)

  // 分类页：全部，按时间降序
  grouped[cat] = normalized
    .slice()
    .sort(
      (a, b) => (new Date(b._created) as any) - (new Date(a._created) as any),
    )
})

// 使用 recentData 作为最近一个月的数据
mergedRecentItems = recentData
  .map((raw: any) => ({
    ...raw,
    _title: raw.title,
    _cover: raw.cover,
    _created: raw.date,
    _uuid: raw.link ? raw.link.split('/')[4] : '',
    category: raw.category || 'unknown',
  }))
  .sort((a, b) => (new Date(b._created) as any) - (new Date(a._created) as any))

// 跳转链接（使用本地 link）
const getLink = (entry: any) =>
  entry.link || `https://neodb.social/${entry.category}/${entry._uuid}`
---

<Layout title='书影音档案' description='我的精神食粮'>
  <div class='container mx-auto'>
    <!-- 把 radio 放在 panels 之前，保证 ~ 兄弟选择器可用 -->
    <div class='tabset mb-6'>
      <input
        id='tab-recent'
        type='radio'
        name='neoTabs'
        class='tab-input'
        checked
      />
      <input id='tab-movie' type='radio' name='neoTabs' class='tab-input' />
      <input id='tab-tv' type='radio' name='neoTabs' class='tab-input' />
      <input id='tab-book' type='radio' name='neoTabs' class='tab-input' />
      <input id='tab-game' type='radio' name='neoTabs' class='tab-input' />

      <div
        class='tabs flex flex-wrap gap-2 md:gap-3 border-b border-black/10 dark:border-white/10 pb-2'>
        <label
          for='tab-recent'
          class='group flex justify-between gap-3 text-sm px-2 py-1 rounded bg-bgdefault dark:bg-fontdefault text-fontdefault dark:text-bgdefault'
          >Last Month</label
        >
        <label
          for='tab-movie'
          class='group flex justify-between gap-3 text-sm px-2 py-1 rounded bg-bgdefault dark:bg-fontdefault text-fontdefault dark:text-bgdefault'
          >{categoryMap.movie}</label
        >
        <!-- <label
          for='tab-tv'
          class='group flex justify-between gap-3 text-sm px-2 py-1 rounded bg-bgdefault dark:bg-fontdefault text-fontdefault dark:text-bgdefault'
          >{categoryMap.tv}</label
        > -->
        <label
          for='tab-book'
          class='group flex justify-between gap-3 text-sm px-2 py-1 rounded bg-bgdefault dark:bg-fontdefault text-fontdefault dark:text-bgdefault'
          >{categoryMap.book}</label
        >
        <label
          for='tab-game'
          class='group flex justify-between gap-3 text-sm px-2 py-1 rounded bg-bgdefault dark:bg-fontdefault text-fontdefault dark:text-bgdefault'
          >{categoryMap.game}</label
        >
      </div>

      <!-- 面板：默认 display:none，由 radio:checked ~ .panels #panel-xxx 控制显示 -->
      <div class='panels mt-6'>
        <!-- 最近（近 1 个月） -->
        <section id='panel-recent' class='tab-panel'>
          {
            mergedRecentItems?.length ? (
              <div class='grid grid-cols-2 md:grid-cols-5 gap-3'>
                {mergedRecentItems.map(entry => (
                  <a
                    href={getLink(entry)}
                    class='block'
                    target='_blank'
                    rel='noopener noreferrer'>
                    <div class='rounded overflow-hidden bg-zinc-100 dark:bg-zinc-800'>
                      <img
                        src={entry._cover}
                        alt={entry._title}
                        loading='lazy'
                        decoding='async'
                        referrerpolicy='no-referrer'
                        class='w-full h-48 object-cover'
                      />
                    </div>
                    <p class='mt-2 text-sm text-center text-gray-500 dark:text-gray-500'>
                      {entry._title}
                    </p>
                  </a>
                ))}
              </div>
            ) : (
              <p class='text-gray-500'>最近 1 个月暂无数据</p>
            )
          }
          <p class='mt-10 text-sm text-gray-400 text-center'>
            ⚠️偶尔会对之前看过的内容进行查漏补缺
          </p>
        </section>

        <!-- 影 -->
        <section id='panel-movie' class='tab-panel'>
          {
            grouped.movie?.length ? (
              <div class='grid grid-cols-2 md:grid-cols-5 gap-3'>
                {grouped.movie.map(entry => (
                  <a
                    href={getLink(entry)}
                    class='block'
                    target='_blank'
                    rel='noopener noreferrer'>
                    <div class='rounded overflow-hidden bg-zinc-100 dark:bg-zinc-800'>
                      <img
                        src={entry._cover}
                        alt={entry._title}
                        loading='lazy'
                        decoding='async'
                        referrerpolicy='no-referrer'
                        class='w-full h-48 object-cover'
                      />
                    </div>
                    <p class='mt-2 text-sm text-center text-gray-500 dark:text-gray-500'>
                      {entry._title}
                    </p>
                  </a>
                ))}
              </div>
            ) : (
              <p class='text-gray-500'>暂无数据</p>
            )
          }
        </section>

        <!-- 剧 -->
        <section id='panel-tv' class='tab-panel'>
          {
            grouped.tv?.length ? (
              <div class='grid grid-cols-2 md:grid-cols-5 gap-3'>
                {grouped.tv.map(entry => (
                  <a
                    href={getLink(entry)}
                    class='block'
                    target='_blank'
                    rel='noopener noreferrer'>
                    <div class='rounded overflow-hidden bg-zinc-100 dark:bg-zinc-800'>
                      <img
                        src={entry._cover}
                        alt={entry._title}
                        loading='lazy'
                        decoding='async'
                        referrerpolicy='no-referrer'
                        class='w-full h-48 object-cover'
                      />
                    </div>
                    <p class='mt-2 text-sm text-center text-gray-500 dark:text-gray-500'>
                      {entry._title}
                    </p>
                  </a>
                ))}
              </div>
            ) : (
              <p class='text-gray-500'>暂无数据</p>
            )
          }
        </section>

        <!-- 书 -->
        <section id='panel-book' class='tab-panel'>
          {
            grouped.book?.length ? (
              <div class='grid grid-cols-2 md:grid-cols-5 gap-3'>
                {grouped.book.map(entry => (
                  <a
                    href={getLink(entry)}
                    class='block'
                    target='_blank'
                    rel='noopener noreferrer'>
                    <div class='rounded overflow-hidden bg-zinc-100 dark:bg-zinc-800'>
                      <img
                        src={entry._cover}
                        alt={entry._title}
                        loading='lazy'
                        decoding='async'
                        referrerpolicy='no-referrer'
                        class='w-full h-48 object-cover'
                      />
                    </div>
                    <p class='mt-2 text-sm text-center text-gray-500 dark:text-gray-500'>
                      {entry._title}
                    </p>
                  </a>
                ))}
              </div>
            ) : (
              <p class='text-gray-500'>暂无数据</p>
            )
          }
        </section>

        <!-- 游 -->
        <section id='panel-game' class='tab-panel'>
          {
            grouped.game?.length ? (
              <div class='grid grid-cols-2 md:grid-cols-5 gap-3'>
                {grouped.game.map(entry => (
                  <a
                    href={getLink(entry)}
                    class='block'
                    target='_blank'
                    rel='noopener noreferrer'>
                    <div class='rounded overflow-hidden bg-zinc-100 dark:bg-zinc-800'>
                      <img
                        src={entry._cover}
                        alt={entry._title}
                        loading='lazy'
                        decoding='async'
                        referrerpolicy='no-referrer'
                        class='w-full h-48 object-cover'
                      />
                    </div>
                    <p class='mt-2 text-sm text-center text-gray-500 dark:text-gray-500'>
                      {entry._title}
                    </p>
                  </a>
                ))}
              </div>
            ) : (
              <p class='text-gray-500'>暂无数据</p>
            )
          }
        </section>
      </div>
    </div>
  </div>

  <style>
    /* 隐藏 radio */
    .tab-input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    /* 面板显示/隐藏 */
    .tab-panel {
      display: none;
    }
    #tab-recent:checked ~ .panels #panel-recent {
      display: block;
    }
    #tab-movie:checked ~ .panels #panel-movie {
      display: block;
    }
    #tab-tv:checked ~ .panels #panel-tv {
      display: block;
    }
    #tab-book:checked ~ .panels #panel-book {
      display: block;
    }
    #tab-game:checked ~ .panels #panel-game {
      display: block;
    }
  </style>
</Layout>
